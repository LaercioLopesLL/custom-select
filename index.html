<!DOCTYPE html>
<html lang="pt-br">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>

		<style>
			.cs-container {
				display: none;
				background-color: #fff;
				border: solid 1px #aaa;
				position: absolute;
				padding: 0.3em;
				border-bottom-left-radius: 6px;
				border-bottom-right-radius: 6px;
				user-select: none;
				font-family: sans-serif;
				font-size: 10pt;
			}

			.cs-feedback {
				font-family: monospace;
				font-size: 1em;
			}

			.cs-table {
				display: block;
				border-collapse: collapse;
				max-height: 100px;
				overflow-y: scroll;
			}

			.cs-actions {
				padding-bottom: 0.3em;
				border-bottom: solid 1px #aaa;
			}

			.cs-table label {
				width: 100%;
				padding: 0.2em 0;
				cursor: pointer;
				display: block;
			}
			.cs-table input {
				cursor: pointer;
			}

			.cs-selected {
				background-color: #ddd;
			}

			.cs-input-container {
				display: inline-block;
				margin-bottom: 1em;
			}
		</style>
	</head>
	<body>
		<form action="">
			<input type="text" placeholder="Nome" id="" />
			<input type="text" placeholder="Email" />
			<input type="text" placeholder="Email" />
			<input type="text" placeholder="Email" />
			<input type="text" placeholder="Email" />
			<select id="select" name="numeros" class="cs">
				<option value="1">Uno</option>
				<option value="2">Dos</option>
				<option value="3">Tres</option>
				<option value="4">Quatro</option>
				<option value="5">Cienco</option>
				<option value="6">Ses</option>
			</select>

			<select id="select" name="numbers" class="cs">
				<option value="1">One</option>
				<option value="2">Two</option>
				<option value="3">Three</option>
				<option value="4">Four</option>
				<option value="5">Five</option>
				<option value="6">Six</option>
				<option value="7">Seven</option>
				<option value="8">Eigth</option>
				<option value="9">Nine</option>
				<option value="10">Ten</option>
				<option value="11">Eleven</option>
				<option value="12">Twelve</option>
			</select>

			<p>
				Lorem ipsum dolor, sit amet consectetur adipisicing elit. Ipsam
				animi impedit in tenetur earum accusantium saepe! Ex possimus,
				aliquam quas sed accusamus at voluptatem minima exercitationem
				sit magnam pariatur! Nulla!
			</p>
		</form>
		<script>
			const customSelects = document.querySelectorAll(".cs");

			function insertAfter(newNode, referenceNode) {
				referenceNode.parentNode.insertBefore(
					newNode,
					referenceNode.nextSibling
				);
			}

			function htmlToElement(html) {
				const template = document.createElement("template");
				html = html.trim();
				template.innerHTML = html;
				return template.content.firstChild;
			}

			customSelects.forEach((select) => {
				let options = [];
				select.querySelectorAll("option").forEach((option) => {
					options.push({
						value: option.value,
						label: option.innerText,
					});
				});

				const inputName = select.getAttribute("name");
				const containerId = inputName + "Container";
				const searchInputId = inputName + "Search";
				const feedbackId = inputName + "Feedback";
				const tableLines = options.reduce((trs, tr) => {
					return (
						trs +
						`<tr>
							<td><label for="${inputName}${tr.value}">${tr.label}</label></td>
							<td><input data-cs-value="${tr.value}" type="checkbox" id="${inputName}${tr.value}" /></td>
						</tr>`
					);
				}, "");
				const container = `
				<div style="display: inline-block">
					<input type="search" id="${searchInputId}" />
					<div id="${containerId}" class="cs-container">
						<div class="cs-actions">
							<button type="button" class="cs-mark-all" data-mark="1">
								Marcar todas
							</button>
							<span class="cs-feedback" id="${feedbackId}"></span>
						</div>
						<table class="cs-table">
							${tableLines}
						</table>
					</div>
				</div>
				`;
				console.log(container);
				insertAfter(htmlToElement(container), select);
				document.querySelector(`#${searchInputId}`).onfocus = () =>
					document.querySelector(`#${searchInputId}`).click();

				document.querySelector(`#${searchInputId}`).onclick = function (
					event
				) {
					event.stopPropagation();

					const element = this;
					const feedback = document.querySelector(`#${feedbackId}`);
					const table = document.querySelector(
						`#${containerId} table`
					);
					const container = document.querySelector(`#${containerId}`);
					let selecteds = [];

					container.querySelector(".cs-mark-all").onclick = function (
						event
					) {
						selecteds = [];
						if (this.dataset.mark) {
							table.querySelectorAll("input").forEach((item) => {
								this.innerText = "Desmarcar todas";
								item.checked = true;
								selecteds.push(parseInt(item.dataset.csValue));
								item.parentElement.parentElement.classList.add(
									"cs-selected"
								);
							});
						} else {
							table.querySelectorAll("input").forEach((item) => {
								this.innerText = "Marcar todas";
								item.checked = false;
								item.parentElement.parentElement.classList.remove(
									"cs-selected"
								);
							});
						}
						feedback.innerText = selecteds;
						this.dataset.mark = !!this.dataset.mark ? "" : "1";
					};

					if (feedback.innerText) {
						selecteds = JSON.parse(`[${feedback.innerText}]`);
					}

					element.onsearch = searchTable;
					element.onkeyup = searchTable;

					container.style.display = "block";

					function hideCs() {
						container.style.display = "none";
					}

					function handleClickWindow(event) {
						if (!container.contains(event.target)) {
							hideCs();
							window.removeEventListener(
								"click",
								handleClickWindow
							);
							element.value = "";
							table
								.querySelectorAll("tr")
								.forEach((item) => (item.style.display = ""));
						}
					}

					table.querySelectorAll("input").forEach((item) => {
						item.onclick = () => {
							const index = selecteds.indexOf(
								parseInt(item.dataset.csValue)
							);
							if (index !== -1) {
								selecteds.splice(index, 1);
							} else {
								selecteds.push(parseInt(item.dataset.csValue));
							}
							feedback.innerText = selecteds;
							item.parentElement.parentElement.classList.toggle(
								"cs-selected"
							);
						};
					});

					window.addEventListener("click", handleClickWindow);

					function searchTable() {
						var input, filter, ul, li, a, i, txtValue;
						input = element;
						filter = input.value.toUpperCase();
						ul = table;
						li = ul.getElementsByTagName("tr");

						for (i = 0; i < li.length; i++) {
							a = li[i].getElementsByTagName("td")[0];
							txtValue = a.textContent || a.innerText;
							if (txtValue.toUpperCase().indexOf(filter) > -1) {
								li[i].style.display = "";
							} else {
								li[i].style.display = "none";
							}
						}
					}
				};
			});
		</script>
	</body>
</html>
